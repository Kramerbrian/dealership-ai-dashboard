{
  "version": "2025-11-07-p2",
  "files": [
    {
      "path": "middleware.ts",
      "contents": "import {authMiddleware} from '@clerk/nextjs';export default authMiddleware({publicRoutes:[\"/\",\"/(mkt)(.*)\",\"/api/v1/analyze\",\"/.well-known/ai-plugin.json\",\"/api/gpt/(.*)\",\"/robots.txt\",\"/sitemap.xml\"],ignoredRoutes:[\"/_next(.*)\",\"/favicon.ico\",\"/og-image.png\"]});export const config={matcher:[\"/((?!_next|.*\\\\..*).*)\"]}"
    },
    {
      "path": ".env.example",
      "contents": "# Clerk\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_...\nCLERK_SECRET_KEY=sk_...\n\n# Supabase\nSUPABASE_URL=https://YOUR_PROJECT.supabase.co\nSUPABASE_SERVICE_ROLE=eyJ...\n\n# Upstash Redis\nUPSTASH_REDIS_REST_URL=https://...\nUPSTASH_REDIS_REST_TOKEN=...\n\n# Google OAuth\nGOOGLE_OAUTH_CLIENT_ID=...\nGOOGLE_OAUTH_CLIENT_SECRET=...\nGOOGLE_OAUTH_REDIRECT_URI=https://your-domain.com/api/oauth/ga4/callback\nGA4_PROPERTY_ID=properties/XXXXX"
    },
    {
      "path": "configs/dealer_segment_table.json",
      "contents": "{\"version\":\"2025.11.07\",\"defaults\":{\"geo_competitor_radius_miles\":{\"start\":10,\"step\":5,\"max\":25,\"min_competitors\":5},\"similarity_weights\":{\"brand_segment\":0.55,\"oem_region\":0.2,\"body_style_focus\":0.2,\"price_band\":0.05},\"price_bands\":[{\"code\":\"entry\",\"min\":0,\"max\":29999},{\"code\":\"mid\",\"min\":30000,\"max\":59999},{\"code\":\"lux\",\"min\":60000,\"max\":99999},{\"code\":\"ultra\",\"min\":100000,\"max\":999999}]},\"brand_segments\":[{\"brands\":[\"Ford\",\"Chevrolet\",\"Dodge\",\"Ram\",\"GMC\",\"Buick\"],\"segment\":\"domestic_mainstream\",\"oem_region\":\"US\"},{\"brands\":[\"Cadillac\",\"Lincoln\"],\"segment\":\"domestic_luxury\",\"oem_region\":\"US\"},{\"brands\":[\"Toyota\",\"Honda\",\"Nissan\",\"Subaru\",\"Mazda\",\"Mitsubishi\",\"Hyundai\",\"Kia\",\"Genesis\"],\"segment\":\"asian_mainstream\",\"oem_region\":\"Asia\"},{\"brands\":[\"Lexus\",\"Acura\",\"Infiniti\"],\"segment\":\"asian_luxury\",\"oem_region\":\"Asia\"},{\"brands\":[\"Mercedes-Benz\",\"BMW\",\"Audi\",\"Porsche\"],\"segment\":\"euro_luxury\",\"oem_region\":\"EU\"},{\"brands\":[\"Volkswagen\",\"Volvo\",\"MINI\",\"Peugeot\",\"Renault\",\"Skoda\",\"Seat\"],\"segment\":\"euro_import\",\"oem_region\":\"EU\"},{\"brands\":[\"Jaguar\",\"Land Rover\",\"Bentley\",\"Rolls-Royce\",\"Aston Martin\",\"McLaren\"],\"segment\":\"euro_ultra_luxury\",\"oem_region\":\"EU\"},{\"brands\":[\"Tesla\",\"Rivian\",\"Lucid\",\"Polestar\"],\"segment\":\"ev_focus\",\"oem_region\":\"Mixed\"}],\"body_style_keywords\":{\"truck\":[\"truck\",\"pickup\",\"f-150\",\"silverado\",\"tundra\",\"ram 1500\",\"sierra\"],\"suv\":[\"suv\",\"crossover\",\"cr-v\",\"rav4\",\"tahoe\",\"highlander\",\"escape\",\"x5\"],\"sedan\":[\"sedan\",\"accord\",\"camry\",\"altima\",\"malibu\",\"sonata\"],\"compact_sedan\":[\"civic\",\"corolla\",\"elantra\",\"jetta\",\"versa\"],\"performance\":[\"amg\",\"m3\",\"m4\",\"rs\",\"gt\",\"z06\",\"hellcat\"],\"ev\":[\"electric\",\"ev\",\"model 3\",\"model y\",\"ioniq\",\"ev6\",\"leaf\",\"bolt\",\"polestar\",\"rivian\",\"lucid\"]},\"competitor_filters\":{\"hard_exclusion\":[\"wholesale_only\",\"fleet_only\",\"salvage_title\",\"car_rental\",\"auction\"],\"soft_exclusion\":[\"independent_small_lot\"]},\"fallbacks\":{\"if_brand_unknown\":\"import_mainstream\",\"if_inventory_unavailable\":\"body_style_from_keywords\",\"if_no_competitors_found_within_max_radius\":\"expand_to_county_line\"}}"
    },
    {
      "path": "configs/onboardingFlow.json",
      "contents": "{\"version\":\"2025.11.07\",\"states\":[{\"id\":\"recognition\",\"entry\":[\"infer_geo_from_ip\",\"infer_oem_from_domain\",\"run_landing_analyzer_cache\",\"preselect_competitors_by_radius\"],\"ui\":{\"headline\":\"Let's see what AI really knows about you.\",\"pulse_seed\":[\"visibility_drop\",\"reviews_latency\",\"schema_missing\"]},\"transitions\":[{\"on\":\"confirm_domain\",\"to\":\"personalize\"}]},{\"id\":\"personalize\",\"ui\":{\"microcards\":[{\"ask\":\"Choose your role\",\"options\":[\"GM\",\"Marketing\",\"Service\"],\"event\":\"role_selected\"},{\"ask\":\"These are your nearest competitors\",\"event\":\"competitors_confirmed\"}],\"locked_grid_hint\":\"Unlock more Pulses by connecting data sources.\"},\"transitions\":[{\"on\":\"role_selected\",\"to\":\"reveal\"},{\"on\":\"competitors_confirmed\",\"to\":\"reveal\"}]},{\"id\":\"reveal\",\"ui\":{\"unlocked_pulses\":3,\"locked_tiles\":[{\"id\":\"traffic\",\"requires\":[\"ga4\"],\"hint\":\"Connect GA4 to reveal AI vs Organic traffic.\"},{\"id\":\"trust\",\"requires\":[\"reviews_api\"],\"hint\":\"Connect your reviews feed to see Trust momentum.\"},{\"id\":\"autopilot\",\"requires\":[\"schema_write_ok\"],\"hint\":\"Enable Autopilot fixes for schema issues.\"}]},\"transitions\":[{\"on\":\"first_fix_success\",\"to\":\"activated\"}]},{\"id\":\"activated\",\"ui\":{\"toast\":\"Nice. You just recovered ${impact}/mo.\",\"next_best_actions\":[{\"id\":\"connect_ga4\",\"when\":\"opened_traffic_card\"},{\"id\":\"connect_reviews\",\"when\":\"opened_trust_card\"},{\"id\":\"enable_autopilot\",\"when\":\"second_fix_success\"}]},\"transitions\":[{\"on\":\"two_integrations_connected\",\"to\":\"integrated\"}]},{\"id\":\"integrated\",\"ui\":{\"brief\":\"Dealer Chronicle will summarize gains daily at 6pm.\",\"unlock_rules\":[{\"pulse\":\"funnel\",\"requires\":[\"crm\"]},{\"pulse\":\"roi\",\"requires\":[\"crm\",\"ga4\"]}]},\"transitions\":[{\"on\":\"seven_day_mark\",\"to\":\"retained\"}]},{\"id\":\"retained\",\"ui\":{\"headline\":\"This week you recovered ${weeklyRecovered}/mo.\",\"cta\":\"Invite Service Director to unlock Service AIO Pulse.\"},\"transitions\":[]}],\"integrations\":{\"ga4\":{\"oauth\":true,\"unlocks\":[\"traffic\",\"impressions_trend\",\"roi_projection\"]},\"reviews_api\":{\"oauth\":true,\"unlocks\":[\"trust_pulse\",\"ugc_health\"]},\"schema_write_ok\":{\"oauth\":false,\"unlocks\":[\"autopilot_schema_fix\"]},\"crm\":{\"oauth\":true,\"unlocks\":[\"funnel\",\"roi_attribution\"]},\"gsc\":{\"oauth\":true,\"unlocks\":[\"seo_query_clusters\",\"zero_click_heat\"]}},\"pulse_unlocks\":[{\"pulse\":\"visibility_drop\",\"requires\":[]},{\"pulse\":\"reviews_latency\",\"requires\":[\"reviews_api?\"],\"soft_mode_hint\":\"Connect Reviews to see live replies.\"},{\"pulse\":\"schema_missing\",\"requires\":[]},{\"pulse\":\"traffic\",\"requires\":[\"ga4\"]},{\"pulse\":\"funnel\",\"requires\":[\"crm\"]},{\"pulse\":\"zero_click_heat\",\"requires\":[\"gsc\"]},{\"pulse\":\"roi_projection\",\"requires\":[\"ga4\",\"crm\"]},{\"pulse\":\"autopilot\",\"requires\":[\"schema_write_ok\"]}],\"competitor_logic\":{\"radius_miles\":{\"start\":10,\"step\":5,\"max\":25},\"min_competitors\":5,\"segment_match\":true,\"allow_adjacent_segments_if_scarce\":true},\"telemetry\":{\"events\":[\"onboarding.start\",\"role.selected\",\"competitors.confirmed\",\"pulse.view\",\"fix.apply_success\",\"integration.connected\",\"drawer.open\",\"brief.sent\"],\"kpis\":{\"domain_to_first_fix_sec\":\"<=60\",\"integrations_by_day7\":\">=2\",\"unlocked_pulses_by_day7\":\">=6\",\"retention_d7\":\">=60%\"}}}"
    },
    {
      "path": "supabase/migrations/20251107_integrations.sql",
      "contents": "create extension if not exists \"uuid-ossp\";create table if not exists public.integrations(id uuid primary key default uuid_generate_v4(),tenant_id text not null,kind text not null,access_token text,refresh_token text,expires_at timestamptz,metadata jsonb,created_at timestamptz not null default now(),updated_at timestamptz not null default now());create unique index if not exists integrations_tenant_kind_idx on public.integrations(tenant_id,kind);create index if not exists integrations_kind_idx on public.integrations(kind);create index if not exists integrations_tenant_idx on public.integrations(tenant_id);create index if not exists integrations_metadata_placeid_idx on public.integrations((metadata->>'place_id'))where kind='reviews';create index if not exists integrations_metadata_engines_idx on public.integrations((metadata->'engines'))where kind='visibility';alter table public.integrations enable row level security;create policy \"service_role_full_access\" on public.integrations for all using(auth.role()='service_role')"
    },
    {
      "path": "lib/auth/tenant.ts",
      "contents": "import {auth} from '@clerk/nextjs';export function requireTenant(){const{userId,orgId,sessionClaims}=auth();const tenantId=(sessionClaims as any)?.tenantId||orgId||userId;if(!tenantId){const err:any=new Error('Unauthorized: tenant not found');err.status=401;throw err}return{tenantId,userId,orgId}}"
    },
    {
      "path": "lib/cache.ts",
      "contents": "import {Redis} from '@upstash/redis';const url=process.env.UPSTASH_REDIS_REST_URL!;const token=process.env.UPSTASH_REDIS_REST_TOKEN!;export const redis=url&&token?new Redis({url,token}):null;export async function cacheJSON<T>(key:string,ttlSec:number,fetcher:()=>Promise<T>):Promise<T>{if(!redis)return fetcher();const hit=await redis.get<T>(key);if(hit)return hit;const fresh=await fetcher();await redis.set(key,fresh,{ex:ttlSec});return fresh}"
    },
    {
      "path": "lib/db/supabaseAdmin.ts",
      "contents": "import {createClient} from '@supabase/supabase-js';const url=process.env.SUPABASE_URL!;const serviceRole=process.env.SUPABASE_SERVICE_ROLE!;export const supabaseAdmin=url&&serviceRole?createClient(url,serviceRole,{auth:{persistSession:false}}):null"
    },
    {
      "path": "lib/integrations/store.ts",
      "contents": "import {supabaseAdmin} from '@/lib/db/supabaseAdmin';export type IntegrationRow={id:string;tenant_id:string;kind:string;access_token:string|null;refresh_token:string|null;expires_at:string|null;metadata:any|null;created_at:string;updated_at:string};export async function getIntegration(tenantId:string,kind:string){if(!supabaseAdmin)throw new Error('Supabase not configured');const{data,error}=await supabaseAdmin.from('integrations').select('*').eq('tenant_id',tenantId).eq('kind',kind).single();if(error&&error.code!=='PGRST116')throw error;return(data as IntegrationRow)||null}export async function upsertIntegration(params:{tenantId:string;kind:string;accessToken?:string|null;refreshToken?:string|null;expiresAt?:string|null;metadata?:any}){if(!supabaseAdmin)throw new Error('Supabase not configured');const{tenantId,kind,accessToken,refreshToken,expiresAt,metadata}=params;const{error}=await supabaseAdmin.from('integrations').upsert({tenant_id:tenantId,kind,access_token:accessToken??null,refresh_token:refreshToken??null,expires_at:expiresAt??null,metadata:metadata??null},{onConflict:'tenant_id,kind'});if(error)throw error}export async function setReviewsPlaceId(tenantId:string,placeId:string,provider:'google'='google'){const existing=await getIntegration(tenantId,'reviews');const metadata={...(existing?.metadata||{}),place_id:placeId,provider};await upsertIntegration({tenantId,kind:'reviews',metadata})}export async function setVisibilityEngines(tenantId:string,engines:Partial<Record<'ChatGPT'|'Perplexity'|'Gemini'|'Copilot',boolean>>){const existing=await getIntegration(tenantId,'visibility');const merged={...(existing?.metadata||{}),engines:{...(existing?.metadata?.engines||{}),...engines}};await upsertIntegration({tenantId,kind:'visibility',metadata:merged})}"
    },
    {
      "path": "lib/google/oauth.ts",
      "contents": "export async function refreshGoogleToken(refreshToken:string){const res=await fetch('https://oauth2.googleapis.com/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:process.env.GOOGLE_OAUTH_CLIENT_ID!,client_secret:process.env.GOOGLE_OAUTH_CLIENT_SECRET!,refresh_token:refreshToken,grant_type:'refresh_token'})});if(!res.ok)throw new Error(`Refresh failed: ${res.status}`);return res.json()as Promise<{access_token:string;expires_in:number;token_type:string;scope?:string}>}export function isExpired(expiresAtISO?:string|null,skewSec=60){if(!expiresAtISO)return true;return Date.now()+skewSec*1000>new Date(expiresAtISO).getTime()}"
    },
    {
      "path": "lib/google/ga4.ts",
      "contents": "type GA4RunReportResponse={rows?:Array<{dimensionValues?:Array<{value?:string}>;metricValues?:Array<{value?:string}>}>};export async function ga4RunReport({accessToken,propertyId}:{accessToken:string;propertyId:string}):Promise<GA4RunReportResponse>{const body={dateRanges:[{startDate:'7daysAgo',endDate:'today'}],metrics:[{name:'sessions'},{name:'screenPageViews'},{name:'averageSessionDuration'},{name:'bounceRate'}]};const res=await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`,{method:'POST',headers:{Authorization:`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify(body)});if(!res.ok)throw new Error(`GA4 runReport failed: ${res.status}`);return res.json()}"
    },
    {
      "path": "lib/adapters/schema.ts",
      "contents": "export type Pulse={id:string;title:string;diagnosis:string;prescription:string;impactMonthlyUSD:number;etaSeconds:number;confidenceScore:number;recencyMinutes:number;kind:'schema'|'faq'};export async function schemaToPulses(domainOrUrl?:string):Promise<Pulse[]>{try{const qs=domainOrUrl?.startsWith('http')?`url=${encodeURIComponent(domainOrUrl)}`:`domain=${encodeURIComponent(domainOrUrl||'')}`;const res=await fetch(`/api/schema/validate?${qs}`,{cache:'no-store'});if(!res.ok)return[];const audit=await res.json();const pulses:Pulse[]=[];const missingProduct=audit.issues?.some((i:any)=>i.id==='missing_product');const missingFAQ=audit.issues?.some((i:any)=>i.id==='missing_faqpage');const missingDealer=audit.issues?.some((i:any)=>i.id==='missing_autodealer');if(missingProduct||missingDealer)pulses.push({id:'schema_missing_vdp',title:'Missing Product/AutoDealer schema',diagnosis:'AI can't extract pricing/specs.',prescription:'Inject JSON-LD Product+AutoDealer; revalidate.',impactMonthlyUSD:8200,etaSeconds:120,confidenceScore:0.85,recencyMinutes:6,kind:'schema'});if(missingFAQ)pulses.push({id:'faq_absent_service',title:'No FAQPage schema',diagnosis:'Gemini/Perplexity need FAQ for citations.',prescription:'Generate 6–10 Q&As; add FAQPage JSON-LD.',impactMonthlyUSD:2400,etaSeconds:150,confidenceScore:0.75,recencyMinutes:6,kind:'faq'});return pulses}catch{return[]}}"
    },
    {
      "path": "lib/adapters/ga4.ts",
      "contents": "export type Pulse={id:string;title:string;diagnosis:string;prescription:string;impactMonthlyUSD:number;etaSeconds:number;confidenceScore:number;recencyMinutes:number;kind:'traffic'|'funnel'};export async function ga4ToPulses(domain?:string):Promise<Pulse[]>{try{const res=await fetch(`/api/ga4/summary?domain=${encodeURIComponent(domain||'')}`,{cache:'no-store'});if(!res.ok)return[];const g=await res.json();const aiShare=g.aiAssistedSessions/Math.max(1,g.sessions);const pulses:Pulse[]=[];if(aiShare<0.18)pulses.push({id:'ga4_ai_low',title:'AI-assisted traffic low',diagnosis:`Only ${(aiShare*100).toFixed(1)}% AI-assisted.`,prescription:'Add FAQ schema; target +5–8% AI share.',impactMonthlyUSD:1900,etaSeconds:180,confidenceScore:0.7,recencyMinutes:10,kind:'traffic'});if(g.bounceRatePct>55)pulses.push({id:'ga4_bounce_high',title:'High bounce reduces conversions',diagnosis:`Bounce ${g.bounceRatePct.toFixed(1)}% last ${g.rangeDays}d.`,prescription:'Compress images; defer scripts; raise CTA.',impactMonthlyUSD:1200,etaSeconds:180,confidenceScore:0.6,recencyMinutes:10,kind:'funnel'});return pulses}catch{return[]}}"
    },
    {
      "path": "lib/adapters/reviews.ts",
      "contents": "export type Pulse={id:string;title:string;diagnosis:string;prescription:string;impactMonthlyUSD:number;etaSeconds:number;confidenceScore:number;recencyMinutes:number;kind:'reviews'|'ugc'};export async function reviewsToPulses(params:{placeId?:string;domain?:string}):Promise<Pulse[]>{try{const q=new URLSearchParams();if(params.placeId)q.set('placeId',params.placeId);if(params.domain)q.set('domain',params.domain);const res=await fetch(`/api/reviews/summary?${q.toString()}`,{cache:'no-store'});if(!res.ok)return[];const r=await res.json();const pulses:Pulse[]=[];if(r.replyLatencyHours>48||r.recentUnanswered>5)pulses.push({id:'reviews_latency',title:`${r.recentUnanswered} unanswered•${r.replyLatencyHours}h`,diagnosis:`Slow replies erode Trust. Rate ${r.replyRatePct}%`,prescription:'Batch-respond; enable alerts; 10am schedule.',impactMonthlyUSD:3100,etaSeconds:120,confidenceScore:0.78,recencyMinutes:20,kind:'reviews'});if(r.last30New<40&&r.avgRating<4.4)pulses.push({id:'reviews_cadence',title:'Low review cadence caps visibility',diagnosis:`${r.last30New} reviews/30d at ${r.avgRating.toFixed(1)}★`,prescription:'SMS ask post-service; target +2/day; QR.',impactMonthlyUSD:1500,etaSeconds:90,confidenceScore:0.65,recencyMinutes:20,kind:'ugc'});return pulses}catch{return[]}}"
    },
    {
      "path": "lib/adapters/visibility.ts",
      "contents": "export type Pulse={id:string;title:string;diagnosis:string;prescription:string;impactMonthlyUSD:number;etaSeconds:number;confidenceScore:number;recencyMinutes:number;kind:'visibility'};export async function visibilityToPulses(domain?:string):Promise<Pulse[]>{try{const res=await fetch(`/api/visibility/presence?domain=${encodeURIComponent(domain||'')}`,{cache:'no-store'});if(!res.ok)return[];const v=await res.json();const map:Record<string,number>={};for(const e of v.engines||[])map[e.name]=e.presencePct;const pulses:Pulse[]=[];if((map.Gemini??0)<75)pulses.push({id:'gemini_low',title:'Gemini weak',diagnosis:`Gemini ${map.Gemini??0}% trails ChatGPT ${map.ChatGPT??0}%`,prescription:'FAQPage on service; Q&A; entity markup.',impactMonthlyUSD:2400,etaSeconds:150,confidenceScore:0.72,recencyMinutes:15,kind:'visibility'});if((map.Copilot??0)<70)pulses.push({id:'copilot_low',title:'Copilot limited',diagnosis:`Copilot ${map.Copilot??0}% weak GBP+schema.`,prescription:'AutoDealer schema; address consistency.',impactMonthlyUSD:1600,etaSeconds:120,confidenceScore:0.66,recencyMinutes:15,kind:'visibility'});return pulses}catch{return[]}}"
    },
    {
      "path": "lib/p13n/engine.ts",
      "contents": "export const personalization={roles:['exec','marketing','service'],cognitiveModes:['standard','reducedMotion','lowContrast'],memoryKeys:['stack','oem','region'],tone:{default:'dry',witty:true},easterEggs:{inception:\"You mustn't be afraid to dream a little bigger.\",milkshake:'I drink your milkshake.',terminator:'Come with me if you want to fix this.',t2:'Hasta la vista, error.',gladiator:'Are you not entertained?'}};type EasterEggEvent='deep_insight'|'aggressive_pull'|'auto_remediation'|'self_healing'|'mission_complete';const eggMap:Record<EasterEggEvent,keyof typeof personalization.easterEggs>={deep_insight:'inception',aggressive_pull:'milkshake',auto_remediation:'terminator',self_healing:'t2',mission_complete:'gladiator'};const lastShown:Record<string,number>={};export function triggerEasterEgg(event:EasterEggEvent,userId:string):string|null{const key=eggMap[event];const now=Date.now();const last=lastShown[`${userId}:${key}`]||0;if(now-last<86400000)return null;lastShown[`${userId}:${key}`]=now;return personalization.easterEggs[key]}"
    },
    {
      "path": "app/api/_utils/withAuth.ts",
      "contents": "import {NextResponse} from 'next/server';import {requireTenant} from '@/lib/auth/tenant';type Handler=(ctx:{req:Request;tenantId:string})=>Promise<Response>;export function withAuth(handler:Handler){return async(req:Request)=>{try{const{tenantId}=requireTenant();return await handler({req,tenantId})}catch(e:any){return NextResponse.json({error:e?.message||'error'},{status:e?.status||500})}}}"
    },
    {
      "path": "app/drive/page.tsx",
      "contents": "'use client';import {useEffect,useMemo,useState} from 'react';import {useUser} from '@clerk/nextjs';import {useRouter} from 'next/navigation';import {triggerEasterEgg} from '@/lib/p13n/engine';export default function Drive(){const{user}=useUser();const router=useRouter();const role=(user?.publicMetadata?.role as any)||'gm';const[feed,setFeed]=useState<any[]>([]);const[drawerOpen,setDrawerOpen]=useState(false);const[preview,setPreview]=useState<any>(null);const[ledger,setLedger]=useState<any[]>([]);const[easterEgg,setEasterEgg]=useState<string|null>(null);useEffect(()=>{(async()=>{const cached=sessionStorage.getItem('dAI:analyzer');const analyzer=cached?JSON.parse(cached):null;const bootstrap=(analyzer?.issues||[]).slice(0,3).map(seedFromIssue);const server=await fetch('/api/pulse/snapshot',{cache:'no-store'}).then(r=>r.json()).catch(()=>[]);setFeed([...bootstrap,...server])})()},[]);const ranked=useMemo(()=>rankPulse(feed,role),[feed,role]);function openFix(p:any){setPreview({summary:p.title,diff:p.diagnosis+'\\n\\n'+p.prescription,risk:'low',etaSeconds:p.etaSeconds,projectedDeltaUSD:p.impactMonthlyUSD});setDrawerOpen(true)}async function onApply(){const rec={id:crypto.randomUUID(),ts:new Date().toISOString(),actor:'human',action:preview.summary,context:'dashboard',deltaUSD:preview.projectedDeltaUSD,undoable:true};setLedger(x=>[rec,...x]);const egg=triggerEasterEgg('auto_remediation',user?.id||'anon');if(egg){setEasterEgg(egg);setTimeout(()=>setEasterEgg(null),4000)}return{ok:true,receiptId:rec.id}}useEffect(()=>{if(ranked.length>=3){const totalImpact=ranked.slice(0,3).reduce((s,p)=>s+p.impactMonthlyUSD,0);if(totalImpact>15000){const egg=triggerEasterEgg('deep_insight',user?.id||'anon');if(egg){setEasterEgg(egg);setTimeout(()=>setEasterEgg(null),4000)}}}},[ranked,user]);return(<main className=\"min-h-screen bg-black text-white\"><header className=\"max-w-7xl mx-auto px-6 py-5 flex items-center justify-between\"><div className=\"flex items-center gap-3\"><div className=\"h-7 w-7 rounded-full bg-white\"/><span className=\"text-white/80\">DealershipAI•Drive</span></div><button onClick={()=>router.push('/onboarding')} className=\"px-4 py-2 rounded-full border border-white/20\">Onboarding</button></header>{easterEgg&&<div className=\"max-w-7xl mx-auto px-6 py-2\"><div className=\"bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white/80 italic\">{easterEgg}</div></div>}<section className=\"max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-8\"><div className=\"space-y-4\">{ranked.slice(0,3).map(p=><div key={p.id} className=\"bg-white/2 border border-white/10 rounded-lg p-5\"><div className=\"text-lg\">{p.title}</div><div className=\"text-sm text-white/60 mt-1\">{p.diagnosis}</div><div className=\"text-sm text-white mt-2\">{p.prescription}</div><div className=\"mt-3 flex items-center justify-between\"><div className=\"text-sm\">Impact:${(p.impactMonthlyUSD/1000).toFixed(1)}K/mo•~{Math.round(p.etaSeconds/60)}min</div><div className=\"flex gap-2\"><button onClick={()=>openFix(p)} className=\"px-4 py-2 rounded-full bg-white text-black\">Fix</button><button className=\"px-4 py-2 rounded-full border border-white/20\">Explain</button></div></div></div>)}</div>{drawerOpen&&<FixDrawer open={drawerOpen} onClose={()=>setDrawerOpen(false)} preview={preview} onApply={onApply}/>}<div className=\"hidden lg:block\"><Ledger receipts={ledger}/></div></section></main>)}function seedFromIssue(i:any){return{id:i.id||crypto.randomUUID(),title:i.title||'Missing schema',diagnosis:i.diagnosis||'AI can't cite.',prescription:i.prescription||'Add schema.',impactMonthlyUSD:i.impact||8200,etaSeconds:90,confidenceScore:0.86,recencyMinutes:14,kind:'schema'}}function rankPulse(feed:any[],role:string){return feed.sort((a,b)=>(b.impactMonthlyUSD/b.etaSeconds*b.confidenceScore)-(a.impactMonthlyUSD/a.etaSeconds*a.confidenceScore))}function FixDrawer({open,onClose,preview,onApply}:any){if(!open)return null;return<div className=\"fixed inset-0 bg-black/80 z-50 flex items-center justify-center\" onClick={onClose}><div className=\"bg-white text-black rounded-2xl p-6 max-w-2xl w-full mx-4\" onClick={e=>e.stopPropagation()}><h2 className=\"text-xl font-bold mb-3\">{preview.summary}</h2><pre className=\"text-sm bg-gray-100 p-4 rounded overflow-auto max-h-40\">{preview.diff}</pre><div className=\"mt-4 flex gap-3\"><button onClick={onApply} className=\"px-6 py-3 rounded-lg bg-black text-white\">Apply</button><button onClick={onClose} className=\"px-6 py-3 rounded-lg border\">Cancel</button></div></div></div>}function Ledger({receipts}:any){return<div className=\"border border-white/10 rounded-lg p-5\"><div className=\"text-white/80 font-semibold mb-3\">Impact Ledger</div>{receipts.length===0?<div className=\"text-white/50 text-sm\">No actions yet</div>:<ul className=\"space-y-2 text-sm\">{receipts.map((r:any)=><li key={r.id} className=\"border-b border-white/10 pb-2\"><div className=\"text-white/80\">{r.action}</div><div className=\"text-white/50\">${(r.deltaUSD/1000).toFixed(1)}K/mo•{new Date(r.ts).toLocaleString()}</div></li>)}</ul>}</div>}"
    },
    {
      "path": "package.json",
      "contents": "{\"name\":\"dealershipai\",\"version\":\"1.4.0-p13n\",\"private\":true,\"scripts\":{\"dev\":\"next dev\",\"build\":\"next build\",\"start\":\"next start\"},\"dependencies\":{\"@clerk/nextjs\":\"^5.0.0\",\"@supabase/supabase-js\":\"^2.39.0\",\"@upstash/redis\":\"^1.28.0\",\"next\":\"14.2.0\",\"react\":\"^18.3.0\",\"react-dom\":\"^18.3.0\"},\"devDependencies\":{\"@types/node\":\"^20\",\"@types/react\":\"^18\",\"autoprefixer\":\"^10.4.19\",\"postcss\":\"^8.4.38\",\"tailwindcss\":\"^3.4.3\",\"typescript\":\"^5.4.5\"}}"
    },
    {
      "path": "README.md",
      "contents": "# DealershipAI Visibility Dashboard\n\n**Version:** 1.4.0-p13n (Part 2 + Personalization)\n\n## Overview\nDealershipAI is a comprehensive AI visibility platform for automotive dealerships. It monitors presence across ChatGPT, Claude, Perplexity, Gemini, and Copilot while providing actionable insights to recover revenue at risk.\n\n## Features\n\n### Core Capabilities\n- **AI Visibility Tracking**: Monitor 5 AI platforms\n- **Pulse Engine**: Identify→Solve→Actionable framework\n- **Competitor Analysis**: Radius-based segmentation (10→25mi)\n- **Schema Validation**: JSON-LD audit for Product, FAQPage, AutoDealer\n- **GA4 Integration**: OAuth + token refresh + traffic analysis\n- **Reviews Management**: GBP integration with reply latency tracking\n- **Personalization Engine**: Role-based UI + easter eggs\n\n### Integrations\n- ✅ Clerk Authentication (tenant-scoped)\n- ✅ Supabase (token persistence)\n- ✅ Upstash Redis (caching layer)\n- ✅ Google OAuth (GA4 + future GBP)\n- ✅ GA4 Data API (auto-refresh tokens)\n\n## Quick Start\n\n```bash\n# Clone and install\nnpm install\n\n# Copy environment template\ncp .env.example .env.local\n\n# Add your keys to .env.local\n# - Clerk (auth)\n# - Supabase (persistence)\n# - Upstash (cache)\n# - Google OAuth (GA4)\n\n# Run migrations\ncd supabase\nsupabase migration up\n\n# Start dev server\nnpm run dev\n```\n\n## Architecture\n\n### Clay Principles\n1. **Identify**: Pulse cards surface issues with $ impact\n2. **Solve**: FixTierDrawer shows preview, ETA, expected ROI\n3. **Actionable**: One-click Fix→Apply→Undo with Impact Ledger\n\n### File Structure\n```\napp/\n  api/\n    competitors/       # Radius-based ranking\n    pulse/snapshot/    # Feed merger (all adapters)\n    ga4/summary/       # OAuth + auto-refresh\n    reviews/summary/   # GBP place_id\n    visibility/        # 4-engine presence\n    schema/validate/   # JSON-LD audit\n    oauth/ga4/         # Google OAuth flow\nlib/\n  adapters/           # Schema, GA4, Reviews, Visibility\n  auth/               # Clerk tenant gating\n  cache.ts            # Upstash Redis\n  db/                 # Supabase admin client\n  integrations/       # Token store helpers\n  google/             # OAuth + GA4 API\n  p13n/               # Personalization + easter eggs\nconfigs/\n  dealer_segment_table.json\n  onboardingFlow.json\n```\n\n### Personalization Engine\n\n#### Easter Eggs (Film References)\n- **Deep Insight**: \"You mustn't be afraid to dream a little bigger.\" (Inception)\n- **Auto-Remediation**: \"Come with me if you want to fix this.\" (Terminator)\n- **Self-Healing**: \"Hasta la vista, error.\" (Terminator 2)\n- **Mission Complete**: \"Are you not entertained?\" (Gladiator)\n- **Aggressive Pull**: \"I drink your milkshake.\" (There Will Be Blood)\n\n**Rules:**\n- Context-triggered (not random)\n- Max 1 per user per 24h\n- Never blocks task completion\n- Dry wit, never slapstick\n\n#### Cognitive Modes\n- `standard`: Default experience\n- `reducedMotion`: Accessibility mode\n- `lowContrast`: Focus-friendly palette\n\n## Deployment\n\n### Vercel (Recommended)\n```bash\nvercel --prod\n```\n\nAdd environment variables in Vercel dashboard.\n\n### Environment Variables\n```env\n# Required\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=\nCLERK_SECRET_KEY=\nSUPABASE_URL=\nSUPABASE_SERVICE_ROLE=\n\n# Optional (enables features)\nUPSTASH_REDIS_REST_URL=\nUPSTASH_REDIS_REST_TOKEN=\nGOOGLE_OAUTH_CLIENT_ID=\nGOOGLE_OAUTH_CLIENT_SECRET=\nGOOGLE_OAUTH_REDIRECT_URI=\nGA4_PROPERTY_ID=\n```\n\n## API Routes\n\n### Tenant-Gated (Clerk)\n- `GET /api/competitors?brand=Toyota` - Radius ranking\n- `GET /api/pulse/snapshot?domain=example.com` - Full feed\n- `GET /api/ga4/summary?domain=example.com` - GA4 metrics\n- `GET /api/reviews/summary?placeId=ChIJ...` - Review stats\n- `GET /api/visibility/presence?domain=example.com` - 4 engines\n\n### Public\n- `GET /api/schema/validate?domain=example.com` - JSON-LD audit\n- `GET /robots.txt` - AI-friendly crawl rules\n- `GET /sitemap.xml` - Dynamic sitemap\n\n## Development\n\n### Add New Adapter\n1. Create `lib/adapters/yourAdapter.ts`\n2. Export `yourAdapterToPulses()` function\n3. Import in `app/api/pulse/snapshot/route.ts`\n4. Add to `Promise.all()` array\n\n### Add New Integration\n1. Add OAuth route in `app/api/oauth/[provider]/`\n2. Store tokens via `upsertIntegration()`\n3. Create summary route in `app/api/[provider]/summary/`\n4. Wire adapter to snapshot\n\n## Telemetry\n\nAll routes log:\n- Tenant ID\n- Route path\n- Latency (ms)\n- Cache hit/miss\n- Error states\n\n## License\nProprietary - DealershipAI © 2025\n\n## Support\nFor questions: support@dealershipai.com"
    },
    {
      "path": "tailwind.config.js",
      "contents": "module.exports={content:['./app/**/*.{ts,tsx}','./components/**/*.{ts,tsx}'],theme:{extend:{}},plugins:[]}"
    },
    {
      "path": "postcss.config.js",
      "contents": "module.exports={plugins:{tailwindcss:{},autoprefixer:{}}}"
    },
    {
      "path": "tsconfig.json",
      "contents": "{\"compilerOptions\":{\"target\":\"ES2022\",\"lib\":[\"ES2022\",\"DOM\"],\"jsx\":\"preserve\",\"module\":\"ESNext\",\"moduleResolution\":\"Bundler\",\"baseUrl\":\".\",\"paths\":{\"@/*\":[\"./*\"]},\"strict\":true,\"noEmit\":true},\"include\":[\"app\",\"lib\",\"configs\"]}"
    }
  ]
}

