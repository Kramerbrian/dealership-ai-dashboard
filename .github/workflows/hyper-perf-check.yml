name: DealershipAI ‚Äì Hyper Performance Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * *"     # Daily performance check
  workflow_dispatch:

jobs:
  hyper-perf-check:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # --- Bundle Size Analysis ---
      - name: Analyze Bundle Size
        id: bundle-analysis
        run: |
          echo "üì¶ Analyzing bundle size..."
          node scripts/analyze-bundle-size.ts || echo "bundle analysis failed"
        continue-on-error: true

      # --- Read Hyper-Optimization Manifest ---
      - name: Read Manifest Thresholds
        id: manifest
        run: |
          if [ -f "dealershipai-hyper-optimization-manifest.json" ]; then
            THRESHOLD=$(node -e "const m=require('./dealershipai-hyper-optimization-manifest.json'); console.log(m.systems.autoProfiling.threshold || '5%')")
            echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          else
            echo "threshold=5%" >> $GITHUB_OUTPUT
          fi

      # --- Check for Regressions ---
      - name: Check Performance Regressions
        id: regression-check
        run: |
          if [ -f "data/build-metrics.json" ]; then
            DELTA=$(node -e "const d=require('./data/build-metrics.json'); console.log(d.deltaPercent || 0)")
            THRESHOLD=${MANIFEST_THRESHOLD:-5}
            if (( $(echo "$DELTA > $THRESHOLD" | bc -l) )); then
              echo "regression=true" >> $GITHUB_OUTPUT
              echo "delta=$DELTA" >> $GITHUB_OUTPUT
            else
              echo "regression=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      # --- Create GitHub Issue on Regression ---
      - name: Create Regression Issue
        if: steps.regression-check.outputs.regression == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const delta = '${{ steps.regression-check.outputs.delta }}';
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Performance Regression: Bundle size increased by ${delta}%`,
              body: `## Performance Regression Detected\n\nBundle size increased by **${delta}%**, exceeding the ${process.env.MANIFEST_THRESHOLD || '5%'} threshold.\n\n### Suggested Actions\n- Run \`npm run analyze\` to identify large dependencies\n- Review recent changes in \`components/\` and \`lib/\`\n- Consider code splitting or lazy loading\n\n### Manifest Reference\nSee \`dealershipai-hyper-optimization-manifest.json\` ‚Üí \`systems.autoProfiling\`\n\n---\n*Auto-generated by Hyper Performance Check workflow*`,
              labels: ['performance', 'regression', 'automated']
            });

      # --- Lighthouse Performance Check ---
      - name: Run Lighthouse Performance Check
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: "https://dealershipai.com"
          configPath: "./.lighthouserc.json"
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      # --- Post Results to Slack ---
      - name: Post Results to Slack
        if: always()
        run: |
          DATE=$(date '+%Y-%m-%d')
          if [ "${{ steps.regression-check.outputs.regression }}" == "true" ]; then
            MSG="‚ö†Ô∏è *Hyper Performance Check ‚Äì ${DATE}*%0A‚Ä¢ Bundle regression detected: ${{ steps.regression-check.outputs.delta }}% increase%0A‚Ä¢ GitHub issue created%0A‚Ä¢ Review required"
          else
            MSG="‚úÖ *Hyper Performance Check ‚Äì ${DATE}*%0A‚Ä¢ Bundle size within threshold%0A‚Ä¢ Lighthouse check complete%0A‚Ä¢ All systems optimal"
          fi
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"${MSG}\"}" $SLACK_WEBHOOK_URL || echo "Slack notification failed"

