name: Production Healthcheck

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}
  # Optional: Run after Vercel deployment completes
  # You can add a webhook from Vercel to trigger this

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check production health endpoint
        id: health
        env:
          # Set this in GitHub Secrets or use default
          APP_URL: ${{ secrets.PRODUCTION_URL || 'https://dealershipai.com' }}
        run: |
          echo "üîç Checking production health at $APP_URL/api/health ..."
          
          # Fetch health endpoint with status code
          RES=$(curl -sS -w "\n%{http_code}" "$APP_URL/api/health" || echo "")
          
          if [ -z "$RES" ]; then
            echo "‚ùå Failed to connect to health endpoint"
            echo "body={}" >> $GITHUB_OUTPUT
            echo "code=000" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          BODY=$(echo "$RES" | head -n1)
          CODE=$(echo "$RES" | tail -n1)
          
          echo "üìä Status code: $CODE"
          echo "üìÑ Response body:"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          # Expose for later steps
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "code=$CODE" >> $GITHUB_OUTPUT
          
          # Check HTTP status code
          if [ "$CODE" -ne 200 ]; then
            echo "‚ùå Healthcheck failed: non-200 status code ($CODE)"
            exit 1
          fi
          
          # Check JSON response for ok: true
          OK=$(echo "$BODY" | jq -r '.ok // empty' || echo "false")
          
          if [ "$OK" != "true" ]; then
            echo "‚ùå Healthcheck failed: ok != true in response JSON"
            echo "Response ok value: '$OK'"
            
            # Show what checks failed
            echo ""
            echo "üîç Failed checks:"
            echo "$BODY" | jq '.checks // {}' || echo "Could not parse checks"
            
            exit 1
          fi
          
          echo "‚úÖ Healthcheck passed: ok=true, status=$CODE"
          
          # Show summary of checks
          echo ""
          echo "üìã Health Summary:"
          echo "$BODY" | jq -r '
            "Environment Variables: " + (if .checks.env then "‚úÖ" else "‚ùå" end),
            "Clarity API: " + (if .checks.clarity.ok then "‚úÖ" else "‚ùå" end),
            "Overall Status: " + (if .ok then "‚úÖ HEALTHY" else "‚ùå UNHEALTHY" end)
          ' || echo "Could not parse summary"

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          APP_URL: ${{ secrets.PRODUCTION_URL || 'https://dealershipai.com' }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL not set, skipping Slack notification"
            exit 0
          fi
          
          BODY="${{ steps.health.outputs.body }}"
          CODE="${{ steps.health.outputs.code }}"
          
          # Extract failure details
          FAILED_CHECKS=$(echo "$BODY" | jq -r '.checks // {}' || echo "{}")
          
          # Build Slack message
          TEXT="‚ùå *DealershipAI Production Healthcheck Failed*
          
          *URL:* $APP_URL/api/health
          *Status Code:* $CODE
          
          *Failed Checks:*
          \`\`\`
          $(echo "$FAILED_CHECKS" | jq -c '.' || echo "Could not parse checks")
          \`\`\`
          
          *GitHub Actions:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$TEXT\"}" \
            "$SLACK_WEBHOOK_URL" || echo "‚ö†Ô∏è  Failed to send Slack notification"

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ steps.health.outputs.body }}`;
            const code = `${{ steps.health.outputs.code }}`;
            const ok = JSON.parse(body || '{}').ok;
            
            const comment = `## üîç Production Healthcheck
            
            ${ok ? '‚úÖ **PASSED**' : '‚ùå **FAILED**'}
            
            - **Status Code:** ${code}
            - **Health Status:** ${ok ? 'OK' : 'FAILED'}
            - **Endpoint:** ${{ secrets.PRODUCTION_URL || 'https://dealershipai.com' }}/api/health
            
            ${!ok ? '‚ö†Ô∏è Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

