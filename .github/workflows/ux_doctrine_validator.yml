name: DealershipAI UX Doctrine Validator

on:
  schedule:
    - cron: "0 6 * * 1"    # Every Monday at 06:00 UTC
  workflow_dispatch:       # Manual trigger from GitHub UI

jobs:
  validate-and-commit:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DOCTRINE_PATH: configs/ux/DealershipAI_Design_Doctrine_v1.0.yaml
      DOCTRINE_VERSION: v1.0
      NEXT_RUN: "Next scheduled: Monday 06:00 UTC"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate & Normalize Doctrine
        id: doctrine
        run: |
          set +e
          python scripts/dealershipai_doctrine_selfheal_autocommit.py $DOCTRINE_PATH > doctrine_log.txt 2>&1
          STATUS=$?
          FIX_COUNT=$(grep -c "Inserted\|Added\|Recreated\|Coerced" doctrine_log.txt || echo "0")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          cat doctrine_log.txt
          set -e

      - name: Commit & Push changes
        if: always()
        run: |
          git config user.name "DealershipAI Bot"
          git config user.email "bot@dealershipai.com"
          git push origin HEAD:main || echo "No changes to push"

      - name: Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "*DealershipAI UX Doctrine Validator — ${{ github.repository }}*",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "DealershipAI UX Doctrine Validator — ${{ job.status }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Version:*\n${{ env.DOCTRINE_VERSION }}" },
                    { "type": "mrkdwn", "text": "*Fixes Applied:*\n${{ steps.doctrine.outputs.fix_count }}" },
                    { "type": "mrkdwn", "text": "*Branch:*\n`${{ github.ref_name }}`" },
                    { "type": "mrkdwn", "text": "*Run ID:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" },
                    { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*Next Run:*\n${{ env.NEXT_RUN }}" }
                  ]
                },
                { "type": "divider" },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Recent Validation Log (last 10 lines):*"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "```$(tail -n 10 doctrine_log.txt)```"
                  }
                }
              ]
            }

      - name: Slack Notification Fallback
        if: failure()
        run: |
          echo "Slack notification failed or webhook not configured."

