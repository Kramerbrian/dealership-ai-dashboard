apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: autonomicorchestrators.orchestration.dealershipai.io
spec:
  group: orchestration.dealershipai.io
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                description:
                  type: string
                components:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      image:
                        type: string
                      schedule:
                        type: string
                      replicas:
                        type: integer
                      mounts:
                        type: array
                        items:
                          type: string
                      outputs:
                        type: array
                        items:
                          type: string
                      env:
                        type: object
                      probes:
                        type: object
                        properties:
                          interval:
                            type: string
                          rule:
                            type: string
                        actions:
                          type: array
                          items:
                            type: string
                      policy:
                        type: object
                      orchestrates:
                        type: array
                        items:
                          type: string
                      scale:
                        type: object
                        properties:
                          min:
                            type: integer
                          max:
                            type: integer
                      subagents:
                        type: array
                        items:
                          type: string
                      consensus_gate:
                        type: number
                      verification:
                        type: array
                        items:
                          type: string
                      notify:
                        type: array
                        items:
                          type: string
                telemetry:
                  type: object
                  properties:
                    storage:
                      type: string
                    logs:
                      type: object
            status:
              type: object
              properties:
                phase:
                  type: string
                components:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      status:
                        type: string
                      lastRun:
                        type: string
                      nextRun:
                        type: string
      subresources:
        status: {}
  scope: Namespaced
  names:
    plural: autonomicorchestrators
    singular: autonomicorchestrator
    kind: AutonomicOrchestrator
    shortNames:
      - dai-orch
      - orch

---
apiVersion: orchestration.dealershipai.io/v1
kind: AutonomicOrchestrator
metadata:
  name: dai-autonomic-orchestrator
  namespace: dealershipai
  labels:
    component: orchestration-core
    version: "2025.11.05"
spec:
  description: >
    Self-regulating orchestration layer that manages AI metric calibration,
    drift detection, and auto-fix deployment across AIV™, ATI™, and CRS pipelines.
  components:
    - name: adaptive-weight-learner
      image: registry.dai.io/adaptive-weight-learner:v1.2
      schedule: "0 2 * * *"
      mounts:
        - /data/prior:/var/lib/priors
        - /data/history:/var/lib/history
      outputs:
        - /data/posteriors
      env:
        DRIFT_THRESHOLD: "2.0"
        SAMPLER_TYPE: "ADVI"
        POSTERIOR_CONFIDENCE: "0.95"
    - name: drift-sentinel
      image: registry.dai.io/drift-sentinel:v1.1
      replicas: 2
      probes:
        interval: "15m"
        rule: "variance>2.0σ"
      actions:
        - "alert:slack"
        - "trigger:retrain"
      retention: "30d"
    - name: rl-controller
      image: registry.dai.io/rl-controller:v1.0
      policy:
        learning_rate: 0.1
        reward_fn: "ΔVisibility * ΔRevenue - API_Cost"
        min_confidence: 0.75
      orchestrates:
        - adaptive-weight-learner
        - drift-sentinel
        - auto-fix-agents
      state_store: redis://redis-svc:6379
      metrics_endpoint: http://metrics-svc:9090
    - name: auto-fix-agents
      image: registry.dai.io/auto-fix-bundle:v3.2
      scale:
        min: 2
        max: 10
      subagents:
        - schema-agent
        - ugc-agent
        - geo-agent
        - cwv-agent
      consensus_gate: 0.92
      verification:
        - "rich-results"
        - "perplexity-check"
      notify:
        - "dashboard"
        - "slack"
        - "webhook"
  telemetry:
    storage: s3://metrics/dealershipai/orchestrator/
    logs:
      retention_days: 90
      encryption: "AES-256"
      append_only: true

