# OpenAI GPT Integration for DealershipAI

## Overview

This integration connects the Algorithmic Visibility Index (AIV) GPT model to the DealershipAI dashboard, enabling AI-powered metrics computation, elasticity updates, and intelligent recommendations.

## Architecture

```
Frontend (DealershipAIDashboard.tsx)
    ↓ HTTPS fetch
Backend API Routes (/api/gpt-proxy, /api/aiv-metrics)
    ↓ OpenAI API calls
OpenAI Assistant (AIV computation)
    ↓ stores results
PostgreSQL + Redis (metrics cache)
```

## Features

- **Secure GPT Proxy**: Backend API routes that safely proxy requests to OpenAI
- **AIV Metrics Panel**: Real-time display of AI Visibility Index scores
- **Elasticity Computation**: Automated calculation of revenue impact per AIV point
- **Historical Trends**: 12-week trend visualization
- **AI Recommendations**: Intelligent insights generated by GPT
- **Auto-refresh**: Configurable data refresh intervals
- **Error Handling**: Comprehensive error handling and fallbacks

## Setup Instructions

### 1. Environment Configuration

Copy the environment template and configure your OpenAI API key:

```bash
cp env-openai-template.txt .env.local
```

Required environment variables:
```env
OPENAI_API_KEY=sk-your-openai-api-key-here
OPENAI_ASSISTANT_ID=asst_your-assistant-id-here
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. Database Setup

Run the database migration to create the required tables:

```bash
# If using Supabase CLI
supabase db push

# Or run the SQL directly in your Supabase dashboard
cat supabase/migrations/20241220000000_add_aiv_tables.sql
```

### 3. OpenAI Assistant Setup

1. Create an OpenAI Assistant in the OpenAI dashboard
2. Configure it with AIV computation instructions
3. Copy the Assistant ID to your environment variables

### 4. Install Dependencies

All required dependencies are already included in `package.json`:
- `openai`: OpenAI API client
- `@tanstack/react-query`: Data fetching and caching
- `@supabase/ssr`: Database integration

## API Endpoints

### GPT Proxy (`/api/gpt-proxy`)

**POST** - Send prompts to GPT and get structured responses

```typescript
// Request
{
  "prompt": "Compute AIV metrics for dealer naplesfordfl.com",
  "dealerId": "naplesfordfl",
  "context": { "market": "Naples, FL", "brand": "Ford" }
}

// Response
{
  "success": true,
  "data": {
    "aiv": 82,
    "ati": 78,
    "crs": 85,
    "elasticity_usd_per_pt": 156.30,
    "r2": 0.87,
    "recommendations": ["Improve local SEO", "Optimize for voice search"]
  },
  "processing_time_ms": 2341
}
```

### AIV Metrics (`/api/aiv-metrics`)

**GET** - Fetch current AIV metrics for a dealer

```typescript
// Request
GET /api/aiv-metrics?dealerId=demo-dealer

// Response
{
  "metrics": {
    "dealer_id": "demo-dealer",
    "aiv_score": 82,
    "ati_score": 78,
    "crs_score": 85,
    "elasticity_usd_per_pt": 156.30,
    "r2_coefficient": 0.87,
    "timestamp": "2024-12-20T10:30:00Z",
    "metadata": {
      "query_count": 160,
      "confidence_score": 0.89,
      "recommendations": ["Improve local SEO citations"]
    }
  },
  "trends": [...],
  "dealerId": "demo-dealer",
  "userRole": "dealership_admin",
  "status": "success"
}
```

**POST** - Update AIV metrics

```typescript
// Request
{
  "dealerId": "demo-dealer",
  "metrics": { /* AIVMetrics object */ }
}
```

### Elasticity Recompute (`/api/elasticity/recompute`)

**POST** - Trigger elasticity recalculation

```typescript
// Request
{
  "dealerId": "demo-dealer",
  "forceRecalculation": false
}

// Response
{
  "success": true,
  "metrics": { /* updated metrics */ },
  "message": "Elasticity recomputed successfully",
  "processing_details": {
    "historical_data_points": 12,
    "confidence_score": 0.89,
    "recommendations_count": 3
  }
}
```

## React Components

### AIVMetricsPanel

Main component for displaying AIV metrics with interactive features:

```tsx
import { AIVMetricsPanel } from '@/components/dashboard/AIVMetricsPanel';

<AIVMetricsPanel 
  dealerId="demo-dealer" 
  className="mb-8" 
/>
```

Features:
- Real-time AIV score display
- Sub-scores (ATI, CRS, R²)
- Elasticity visualization
- 12-week trend chart
- AI recommendations
- Manual recompute buttons
- Expandable details

### React Hooks

#### useAIVMetrics

```tsx
import { useAIVMetrics } from '@/hooks/useAIVMetrics';

const { data, isLoading, error, refetch } = useAIVMetrics('demo-dealer', {
  refetchInterval: 60000, // 1 minute
  enabled: true
});
```

#### useRecomputeElasticity

```tsx
import { useRecomputeElasticity } from '@/hooks/useAIVMetrics';

const recomputeElasticity = useRecomputeElasticity();

const handleRecompute = () => {
  recomputeElasticity.mutate({ 
    dealerId: 'demo-dealer', 
    forceRecalculation: false 
  });
};
```

#### useAIVMetricsWithRefresh

Combined hook with auto-refresh and all actions:

```tsx
import { useAIVMetricsWithRefresh } from '@/hooks/useAIVMetrics';

const {
  metrics,
  trends,
  elasticity,
  isLoading,
  refetch,
  recomputeElasticity,
  computeAIV,
  isRecomputing,
  isComputing
} = useAIVMetricsWithRefresh('demo-dealer', 60000);
```

## Database Schema

### aiv_weekly Table

```sql
CREATE TABLE aiv_weekly (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    dealer_id TEXT NOT NULL,
    aiv_score INTEGER NOT NULL DEFAULT 0 CHECK (aiv_score >= 0 AND aiv_score <= 100),
    ati_score INTEGER NOT NULL DEFAULT 0 CHECK (ati_score >= 0 AND ati_score <= 100),
    crs_score INTEGER NOT NULL DEFAULT 0 CHECK (crs_score >= 0 AND crs_score <= 100),
    elasticity_usd_per_pt DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    r2_coefficient DECIMAL(5,4) NOT NULL DEFAULT 0.0000,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Row Level Security

All tables have RLS enabled with policies that ensure:
- Users can only access dealers they have permission for
- Admins can update metrics for their dealers
- Audit logs track all changes

## Error Handling

The integration includes comprehensive error handling:

- **Rate Limiting**: Built-in rate limiting for API calls
- **Timeout Handling**: 30-second timeout for GPT requests
- **Fallback Data**: Cached data served when API fails
- **User-Friendly Messages**: Clear error messages for users
- **Retry Logic**: Automatic retries with exponential backoff

## Security Features

- **API Key Protection**: OpenAI API key never exposed to frontend
- **Input Validation**: All inputs validated and sanitized
- **Authentication**: Supabase auth integration
- **Authorization**: Role-based access control
- **Audit Logging**: All actions logged for compliance

## Performance Optimizations

- **Caching**: React Query caching with configurable stale times
- **Batch Processing**: Multiple queries batched when possible
- **Lazy Loading**: Components load data only when needed
- **Optimistic Updates**: UI updates immediately, syncs in background

## Testing

### Manual Testing

1. **Test GPT Proxy**:
   ```bash
   curl -X POST http://localhost:3000/api/gpt-proxy \
     -H "Content-Type: application/json" \
     -d '{"prompt": "Test AIV computation", "dealerId": "demo-dealer"}'
   ```

2. **Test AIV Metrics**:
   ```bash
   curl http://localhost:3000/api/aiv-metrics?dealerId=demo-dealer
   ```

3. **Test Elasticity Recompute**:
   ```bash
   curl -X POST http://localhost:3000/api/elasticity/recompute \
     -H "Content-Type: application/json" \
     -d '{"dealerId": "demo-dealer"}'
   ```

### Component Testing

The AIVMetricsPanel component can be tested by:
1. Setting up a test dealer in the database
2. Adding sample AIV metrics
3. Rendering the component in the dashboard
4. Testing all interactive features

## Monitoring

### Key Metrics to Monitor

- **API Response Times**: Should be < 3 seconds
- **Error Rates**: Should be < 1%
- **Cache Hit Rates**: Should be > 70%
- **User Engagement**: Time spent on AIV panel

### Logging

All API calls are logged with:
- Request/response times
- Error details
- User context
- Dealer information

## Troubleshooting

### Common Issues

1. **"OpenAI API key not configured"**
   - Check `.env.local` has `OPENAI_API_KEY`
   - Restart development server

2. **"Access denied to this dealer"**
   - Verify user has access in `dealer_access` table
   - Check RLS policies

3. **"Assistant run failed"**
   - Verify `OPENAI_ASSISTANT_ID` is correct
   - Check OpenAI Assistant is active

4. **"No AIV data available"**
   - Run initial computation via "Compute Initial AIV" button
   - Check database has sample data

### Debug Mode

Enable debug logging by setting:
```env
NODE_ENV=development
DEBUG=dealershipai:*
```

## Future Enhancements

- **Real-time Updates**: WebSocket integration for live updates
- **Batch Processing**: Process multiple dealers simultaneously
- **Advanced Analytics**: More sophisticated trend analysis
- **Custom Models**: Fine-tuned models for specific markets
- **API Rate Optimization**: Smarter caching and batching

## Support

For issues or questions:
1. Check the troubleshooting section
2. Review API logs in Supabase
3. Test with sample data first
4. Contact support with specific error messages

## License

This integration is part of the DealershipAI platform and follows the same licensing terms.
